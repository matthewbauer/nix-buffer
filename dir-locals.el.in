(require 'json)
(require 'subr-x)
(require 'esh-util)

;; TODO: move common stuff to function in nix-buffer.el

(defvar-local nix-buffer-env (json-read-file "@env@"))

;; setenv modifies in place, so copy the environment first
(put 'process-environment 'permanent-local t)
(setq-local process-environment (copy-tree process-environment))

(dolist (x nix-buffer-env)
  (unless (memq (car x) '(HOME TMP TMPDIR TEMP PATH SSL_CERT_FILE PWD))
    (setenv (symbol-name (car x)) (cdr x))))

;; donâ€™t override parent PATH
(setenv "PATH" (concat (alist-get 'PATH nix-buffer-env) ":" (getenv "PATH")))

(put 'exec-path 'permanent-local t)
(setq-local exec-path (split-string (getenv "PATH") ":"))

(put 'eshell-path-env 'permanent-local t)
(setq-local eshell-path-env (getenv "PATH"))

;; Local Variables:
;; flycheck-disabled-checkers: (emacs-lisp-checkdoc)
;; End:
