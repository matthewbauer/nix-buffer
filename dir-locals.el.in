(require 'json)
(require 'subr-x)
(require 'esh-util)

;; TODO: move common stuff to function in nix-buffer.el

;; setenv modifies in place, so copy the environment first
(put 'process-environment 'permanent-local t)
(setq-local process-environment (copy-tree process-environment))

(defun setenvs (env)
  "Set environment variables from ENV alist."
  (dolist (x env)
    (unless (memq (car x) '(HOME TMP TMPDIR TEMP PATH))
      (setenv (symbol-name (car x)) (cdr x)))))

(setenvs (json-read-file "@env@"))

(put 'exec-path 'permanent-local t)
(setq-local exec-path (append (split-string (getenv "PATH") ":") exec-path))

(put 'eshell-path-env 'permanent-local t)
(setq-local eshell-path-env (getenv "PATH"))

;; Local Variables:
;; flycheck-disabled-checkers: (emacs-lisp-checkdoc)
;; End:
